<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="YT7QzoP0CGYZziDQuLr2aOTGGmpgioKi3izg5T1vBPs" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="yongfeiuall,唐胡璐,软件测试,自动化测试,性能测试,Software Testing,QTP,Selenium,Performance Testing" />





  <link rel="alternate" href="/atom.xml" title="YONGFEIUALL" type="application/atom+xml" />






<meta name="description" content="i just wanna live while i am alive">
<meta property="og:type" content="website">
<meta property="og:title" content="YONGFEIUALL">
<meta property="og:url" content="http://izheyi.com/page/5/index.html">
<meta property="og:site_name" content="YONGFEIUALL">
<meta property="og:description" content="i just wanna live while i am alive">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YONGFEIUALL">
<meta name="twitter:description" content="i just wanna live while i am alive">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://izheyi.com/page/5/"/>





  <title>YONGFEIUALL</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?964433a58390bc50ac82f1418eb8dc8e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YONGFEIUALL</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">izheyi.com</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'fZPEsEHs3tafejXBDpZs','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/28/Java项目实战-SSO集成Portal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/28/Java项目实战-SSO集成Portal/" itemprop="url">Java项目实战-SSO集成Portal</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-28T20:13:42+08:00">
                2018-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/28/Java项目实战-SSO集成Portal/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/28/Java项目实战-SSO集成Portal/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="业务"><a href="#业务" class="headerlink" title="业务"></a>业务</h1><p>在Portal点击登录跳转到SSO登录页面，登录后，跳转到Portal首页。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>在Portal中需要从cookie中把token取出来。所以必须在登录成功后把token写入cookie，且cookie的值必须在系统之间能共享。<br>要在SsoService加上cookie:<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	<span class="keyword">public</span> TaotaoResult userLogin(<span class="built_in">String</span> username, <span class="built_in">String</span> password, HttpServletRequest request, HttpServletResponse response) &#123;</span><br><span class="line">		TbUserExample example = <span class="literal">new</span> TbUserExample();</span><br><span class="line">		Criteria criteria = example<span class="built_in">.</span>createCriteria();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// username</span></span><br><span class="line">		criteria<span class="built_in">.</span>andUsernameEqualTo(username);</span><br><span class="line">		<span class="built_in">List</span>&lt;TbUser&gt; <span class="built_in">list</span> = userMapper<span class="built_in">.</span>selectByExample(example);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">list</span> == <span class="built_in">null</span> <span class="subst">||</span> <span class="built_in">list</span><span class="built_in">.</span>size() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>build(<span class="number">400</span>, <span class="string">"username or password wrong"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// password</span></span><br><span class="line">		TbUser user = <span class="built_in">list</span><span class="built_in">.</span>get(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="subst">!</span>DigestUtils<span class="built_in">.</span>md5DigestAsHex(password<span class="built_in">.</span>getBytes())<span class="built_in">.</span><span class="keyword">equals</span>(user<span class="built_in">.</span>getPassword())) &#123;</span><br><span class="line">			<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>build(<span class="number">400</span>, <span class="string">"username or password wrong"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// token</span></span><br><span class="line">		<span class="built_in">String</span> token = UUID<span class="built_in">.</span>randomUUID()<span class="built_in">.</span>toString();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// add redis</span></span><br><span class="line">		redisPool<span class="built_in">.</span><span class="built_in">set</span>(SSO_SESSION_KEY + <span class="string">":"</span> + token, JsonUtils<span class="built_in">.</span>objectToJson(user));</span><br><span class="line">		redisPool<span class="built_in">.</span>expire(SSO_SESSION_KEY + <span class="string">":"</span> + token, SSO_SESSION_EXPIRE);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// add cookie</span></span><br><span class="line">		CookieUtils<span class="built_in">.</span>setCookie(request, response, <span class="string">"Z_TOKEN"</span>, token);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//return token</span></span><br><span class="line">		<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>ok(token);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h1><p>Interceptor拦截器用于拦截Controller层接口，以下3个步骤实现：</p>
<ol>
<li>需要实现HandlerInterceptor接口。</li>
<li>实现拦截逻辑</li>
<li>需要在springmvc.xml中配置。</li>
</ol>
<h2 id="实现HandlerInterceptor接口"><a href="#实现HandlerInterceptor接口" class="headerlink" title="实现HandlerInterceptor接口"></a>实现HandlerInterceptor接口</h2><p>Service:<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Service</span></span><br><span class="line">public class <span class="type">UserServiceImpl</span> implements <span class="type">UserService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;SSO_BASE_URL&#125;"</span>)</span><br><span class="line">	public <span class="type">String</span> <span class="type">SSO_BASE_URL</span>;</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;SSO_USER_TOKEN&#125;"</span>)</span><br><span class="line">	public <span class="type">String</span> <span class="type">SSO_USER_TOKEN</span>;</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;SSO_USER_LOGIN&#125;"</span>)</span><br><span class="line">	public <span class="type">String</span> <span class="type">SSO_USER_LOGIN</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	@<span class="type">Override</span></span><br><span class="line">	public <span class="type">TbUser</span> getUserByToken(<span class="type">String</span> token) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">String</span> json = <span class="type">HttpClientUtil</span>.doGet(<span class="type">SSO_BASE_URL</span> + <span class="type">SSO_USER_TOKEN</span> + token);</span><br><span class="line">			<span class="type">TaotaoResult</span> <span class="literal">result</span> = <span class="type">TaotaoResult</span>.formatToPojo(json, <span class="type">TbUser</span>.class);</span><br><span class="line">			<span class="keyword">if</span> (<span class="literal">result</span>.getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">				<span class="type">TbUser</span> user = (<span class="type">TbUser</span>) <span class="literal">result</span>.getData();</span><br><span class="line">				<span class="keyword">return</span> user;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> null;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Interceptor:<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">/// get token from cookie</span></span><br><span class="line">		String token = CookieUtils.getCookieValue(request, <span class="string">"Z_TOKEN"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// get user by token</span></span><br><span class="line">		TbUser user = userService.getUserByToken(token);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">			response.sendRedirect(userService.SSO_BASE_URL + userService.SSO_USER_LOGIN </span><br><span class="line">					+ <span class="string">"?redirect="</span> + request.getRequestURI());</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>springmvc.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 拦截器配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">mvc:interceptors</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">mvc:interceptor</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 拦截订单类请求 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">mvc:mapping</span> <span class="attribute">path</span>=<span class="value">"/item/**"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"com.izheyi.portal.interceptor.LoginInterceptor"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="title">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/images/javaproject/interceptor.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/28/Java项目实战-SSO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/28/Java项目实战-SSO/" itemprop="url">Java项目实战-SSO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-28T16:49:00+08:00">
                2018-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/28/Java项目实战-SSO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/28/Java项目实战-SSO/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>创建一个新工程zheyi-sso，要用到Redis和DB。</p>
<h1 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h1><p>在注册用户之前，要先检查注册的用户信息的正确性。</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * check user date</span><br><span class="line"> * @see com.izheyi.sso.service.SsoService#checkUserData(java.lang.String, java.lang.Integer)</span><br><span class="line"> */</span></span><br><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> TaotaoResult checkUserData(<span class="built_in">String</span> content, <span class="built_in">Integer</span> <span class="keyword">type</span>) &#123;</span><br><span class="line">	TbUserExample userExample = <span class="literal">new</span> TbUserExample();</span><br><span class="line">	Criteria criteria = userExample<span class="built_in">.</span>createCriteria();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">type</span> == <span class="number">1</span>) &#123;</span><br><span class="line">		criteria<span class="built_in">.</span>andUsernameEqualTo(content);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">type</span> == <span class="number">2</span>) &#123;</span><br><span class="line">		criteria<span class="built_in">.</span>andPhoneEqualTo(content);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		criteria<span class="built_in">.</span>andEmailEqualTo(content);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">List</span>&lt;TbUser&gt; <span class="built_in">list</span> = userMapper<span class="built_in">.</span>selectByExample(userExample);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">list</span> == <span class="built_in">null</span> <span class="subst">||</span> <span class="built_in">list</span><span class="built_in">.</span>size() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>ok(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>ok(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * create user</span><br><span class="line"> * @see com.izheyi.sso.service.SsoService#createUser(com.izheyi.pojo.TbUser)</span><br><span class="line"> */</span></span><br><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> TaotaoResult createUser(TbUser user) &#123;</span><br><span class="line">	user<span class="built_in">.</span>setCreated(<span class="literal">new</span> <span class="built_in">Date</span>());</span><br><span class="line">	user<span class="built_in">.</span>setUpdated(<span class="literal">new</span> <span class="built_in">Date</span>());</span><br><span class="line">	</span><br><span class="line">	user<span class="built_in">.</span>setPassword(DigestUtils<span class="built_in">.</span>md5DigestAsHex(user<span class="built_in">.</span>getPassword()<span class="built_in">.</span>getBytes()));</span><br><span class="line">	userMapper<span class="built_in">.</span>insert(user);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">	 * check user data</span><br><span class="line">	 */</span><br><span class="line">	@<span class="type">RequestMapping</span>(<span class="string">"/check/&#123;param&#125;/&#123;type&#125;"</span>)</span><br><span class="line">	@<span class="type">ResponseBody</span></span><br><span class="line">	public <span class="type">Object</span> checkUserData(@<span class="type">PathVariable</span> <span class="type">String</span> param, @<span class="type">PathVariable</span> <span class="type">Integer</span> <span class="keyword">type</span>, <span class="type">String</span> callback) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="type">TaotaoResult</span> <span class="literal">result</span> = null;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="literal">result</span> = ssoService.checkUserData(param, <span class="keyword">type</span>);</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (!<span class="type">StringUtils</span>.isBlank(callback)) &#123;</span><br><span class="line">			<span class="type">MappingJacksonValue</span> mappingJacksonValue = new <span class="type">MappingJacksonValue</span>(<span class="literal">result</span>);</span><br><span class="line">			mappingJacksonValue.setJsonpFunction(callback);</span><br><span class="line">			<span class="keyword">return</span> mappingJacksonValue;</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/*</span><br><span class="line">	 * create user</span><br><span class="line">	 */</span><br><span class="line">	@<span class="type">RequestMapping</span>(value=<span class="string">"/register"</span>, <span class="keyword">method</span>=<span class="type">RequestMethod</span>.<span class="type">POST</span>)</span><br><span class="line">	@<span class="type">ResponseBody</span></span><br><span class="line">	public <span class="type">TaotaoResult</span> createUser(<span class="type">TbUser</span> user) &#123;</span><br><span class="line">		<span class="type">TaotaoResult</span> <span class="literal">result</span> = null;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="literal">result</span> = ssoService.createUser(user);</span><br><span class="line">			</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/sso_user_register.jpg" alt=""></p>
<h1 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h1><h2 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h2><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	<span class="keyword">public</span> TaotaoResult userLogin(<span class="built_in">String</span> username, <span class="built_in">String</span> password) &#123;</span><br><span class="line">		TbUserExample example = <span class="literal">new</span> TbUserExample();</span><br><span class="line">		Criteria criteria = example<span class="built_in">.</span>createCriteria();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// username</span></span><br><span class="line">		criteria<span class="built_in">.</span>andUsernameEqualTo(username);</span><br><span class="line">		<span class="built_in">List</span>&lt;TbUser&gt; <span class="built_in">list</span> = userMapper<span class="built_in">.</span>selectByExample(example);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">list</span> == <span class="built_in">null</span> <span class="subst">||</span> <span class="built_in">list</span><span class="built_in">.</span>size() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>build(<span class="number">400</span>, <span class="string">"username or password wrong"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// password</span></span><br><span class="line">		TbUser user = <span class="built_in">list</span><span class="built_in">.</span>get(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="subst">!</span>DigestUtils<span class="built_in">.</span>md5DigestAsHex(password<span class="built_in">.</span>getBytes())<span class="built_in">.</span><span class="keyword">equals</span>(user<span class="built_in">.</span>getPassword())) &#123;</span><br><span class="line">			<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>build(<span class="number">400</span>, <span class="string">"username or password wrong"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// token</span></span><br><span class="line">		<span class="built_in">String</span> token = UUID<span class="built_in">.</span>randomUUID()<span class="built_in">.</span>toString();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// add redis</span></span><br><span class="line">		redisPool<span class="built_in">.</span><span class="built_in">set</span>(SSO_SESSION_KEY + <span class="string">":"</span> + token, JsonUtils<span class="built_in">.</span>objectToJson(user));</span><br><span class="line">		redisPool<span class="built_in">.</span>expire(SSO_SESSION_KEY + <span class="string">":"</span> + token, SSO_SESSION_EXPIRE);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//return token</span></span><br><span class="line">		<span class="keyword">return</span> TaotaoResult<span class="built_in">.</span>ok(token);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">RequestMapping</span>(value=<span class="string">"/login"</span>, <span class="keyword">method</span>=<span class="type">RequestMethod</span>.<span class="type">POST</span>)</span><br><span class="line">@<span class="type">ResponseBody</span></span><br><span class="line">public <span class="type">TaotaoResult</span> userLogin(<span class="type">String</span> username, <span class="type">String</span> password)&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">TaotaoResult</span> <span class="literal">result</span> = ssoService.userLogin(username, password);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="keyword">return</span> <span class="type">TaotaoResult</span>.build(<span class="number">500</span>, <span class="type">ExceptionUtil</span>.getStackTrace(e));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/sso_user_login.jpg" alt=""></p>
<h1 id="查询用户-By-Token"><a href="#查询用户-By-Token" class="headerlink" title="查询用户 By Token"></a>查询用户 By Token</h1><h2 id="Service-2"><a href="#Service-2" class="headerlink" title="Service"></a>Service</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Override</span></span><br><span class="line">public <span class="type">TaotaoResult</span> getUserByToken(<span class="type">String</span> token) &#123;</span><br><span class="line">	<span class="type">String</span> <span class="literal">result</span> = redisPool.get(<span class="type">SSO_SESSION_KEY</span> + <span class="string">":"</span> + token);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="type">StringUtils</span>.isBlank(<span class="literal">result</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="type">TaotaoResult</span>.build(<span class="number">400</span>, <span class="string">"session expired, please relogin"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	redisPool.expire(<span class="type">SSO_SESSION_KEY</span> + <span class="string">":"</span> + token, <span class="type">SSO_SESSION_EXPIRE</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="type">TaotaoResult</span>.ok(<span class="type">JsonUtils</span>.jsonToPojo(<span class="literal">result</span>, <span class="type">TbUser</span>.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Controller-2"><a href="#Controller-2" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">RequestMapping</span>(<span class="string">"/token/&#123;token&#125;"</span>)</span><br><span class="line">@<span class="type">ResponseBody</span></span><br><span class="line">public <span class="type">Object</span> getUserByToken(@<span class="type">PathVariable</span> <span class="type">String</span> token, <span class="type">String</span> callback) &#123;</span><br><span class="line">	<span class="type">TaotaoResult</span> <span class="literal">result</span> = null;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="literal">result</span> = ssoService.getUserByToken(token);</span><br><span class="line">	&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		<span class="literal">result</span> = <span class="type">TaotaoResult</span>.build(<span class="number">500</span>, <span class="type">ExceptionUtil</span>.getStackTrace(e));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!<span class="type">StringUtils</span>.isBlank(callback)) &#123;</span><br><span class="line">		<span class="type">MappingJacksonValue</span> mappingJacksonValue = new <span class="type">MappingJacksonValue</span>(<span class="literal">result</span>);</span><br><span class="line">		mappingJacksonValue.setJsonpFunction(callback);</span><br><span class="line">		<span class="keyword">return</span> mappingJacksonValue;</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/sso_user_token.jpg" alt=""></p>
<h1 id="实现SSO功能"><a href="#实现SSO功能" class="headerlink" title="实现SSO功能"></a>实现SSO功能</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Controller</span></span><br><span class="line"><span class="annotation">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@RequestMapping</span>(<span class="string">"/register"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">registerPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"register"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@RequestMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">loginPage</span><span class="params">(String redirect, Model model)</span> </span>&#123;</span><br><span class="line">		model.addAttribute(<span class="string">"redirect"</span>, redirect);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这，登录和注册的功能在SSO系统中完成，其他系统可调用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/25/Java项目实战-展示商品详情页/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/25/Java项目实战-展示商品详情页/" itemprop="url">Java项目实战 - 展示商品详情页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-25T12:54:48+08:00">
                2018-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/25/Java项目实战-展示商品详情页/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/25/Java项目实战-展示商品详情页/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="发布服务"><a href="#发布服务" class="headerlink" title="发布服务"></a>发布服务</h1><p>zheyi-rest实现：商品基本信息和描述的显示，并添加缓存。</p>
<h1 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h1><p>无。</p>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceImpl</span> <span class="keyword">implements</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Value</span>(<span class="string">"$&#123;REDIS_ITEM_KEY&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String REDIS_ITEM_KEY;</span><br><span class="line">	<span class="annotation">@Value</span>(<span class="string">"$&#123;REDIS_ITEM_EXPIRE&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> Integer REDIS_ITEM_EXPIRE;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TbItemMapper itemMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TbItemDescMapper itemDescMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function">TaotaoResult <span class="title">getItemBasicInfo</span><span class="params">(<span class="keyword">long</span> itemId)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//get cache</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String cache = redisUtils.get(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":basic"</span>);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.isBlank(cache)) &#123;</span><br><span class="line">				TbItem item = JsonUtils.jsonToPojo(cache, TbItem.class);</span><br><span class="line">				<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">(item)</span></span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		TbItem item = itemMapper.selectByPrimaryKey(itemId);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//add cache</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			redisUtils.set(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":basic"</span>, JsonUtils.objectToJson(item));</span><br><span class="line">			redisUtils.expire(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":basic"</span>, REDIS_ITEM_EXPIRE);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">(item)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function">TaotaoResult <span class="title">getItemDesc</span><span class="params">(<span class="keyword">long</span> itemId)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//get cache</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String cache = redisUtils.get(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":desc"</span>);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.isBlank(cache)) &#123;</span><br><span class="line">				</span><br><span class="line">				TbItemDesc itemDesc = JsonUtils.jsonToPojo(cache, TbItemDesc.class);</span><br><span class="line">				<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">(itemDesc)</span></span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		TbItemDesc itemDesc = itemDescMapper.selectByPrimaryKey(itemId);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//add cache</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			redisUtils.set(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":desc"</span>, JsonUtils.objectToJson(itemDesc));</span><br><span class="line">			redisUtils.expire(REDIS_ITEM_KEY + <span class="string">":"</span> + itemId + <span class="string">":desc"</span>, REDIS_ITEM_EXPIRE);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">(itemDesc)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Portal调用"><a href="#Portal调用" class="headerlink" title="Portal调用"></a>Portal调用</h1><p>zheyi-portal实现：当用户访问商品详情页面时，需要加载商品信息。</p>
<h1 id="Dao-1"><a href="#Dao-1" class="headerlink" title="Dao"></a>Dao</h1><p>需要添加POJO:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ItemInfo</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">TbItem</span>&#123;</span></span><br><span class="line">	</span><br><span class="line">	public <span class="type">String</span>[] getImages() &#123;</span><br><span class="line">		<span class="type">String</span> image = getImage();</span><br><span class="line">		<span class="keyword">if</span> (image != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">String</span>[] images = image.split(<span class="string">","</span>);</span><br><span class="line">			<span class="keyword">return</span> images;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Service</span></span><br><span class="line">public class <span class="type">ItemServiceImpl</span> implements <span class="type">ItemService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;REST_BASE_URL&#125;"</span>)</span><br><span class="line">	private <span class="type">String</span> <span class="type">REST_BASE_URL</span>;</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;ITEM_INFO&#125;"</span>)</span><br><span class="line">	private <span class="type">String</span> <span class="type">ITEM_INFO</span>;</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;ITEM_DESC_URL&#125;"</span>)</span><br><span class="line">	private <span class="type">String</span> <span class="type">ITEM_DESC_URL</span>;</span><br><span class="line"></span><br><span class="line">	@<span class="type">Override</span></span><br><span class="line">	public <span class="type">ItemInfo</span> getItemById(<span class="type">Long</span> itemId) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">String</span> itemJson = <span class="type">HttpClientUtil</span>.doGet(<span class="type">REST_BASE_URL</span> + <span class="type">ITEM_INFO</span> + itemId);</span><br><span class="line">			<span class="keyword">if</span> (!<span class="type">StringUtils</span>.isBlank(itemJson)) &#123;</span><br><span class="line">				<span class="type">TaotaoResult</span> <span class="literal">result</span> = <span class="type">TaotaoResult</span>.formatToPojo(itemJson, <span class="type">ItemInfo</span>.class);</span><br><span class="line">				<span class="keyword">if</span> (<span class="literal">result</span>.getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">					<span class="type">ItemInfo</span> itemInfo = (<span class="type">ItemInfo</span>) <span class="literal">result</span>.getData();</span><br><span class="line">					<span class="keyword">return</span> itemInfo;</span><br><span class="line">				&#125;	</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> null;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Override</span></span><br><span class="line">	public <span class="type">String</span> getItemDescById(<span class="type">Long</span> itemId) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			//查询商品描述</span><br><span class="line">			<span class="type">String</span> json = <span class="type">HttpClientUtil</span>.doGet(<span class="type">REST_BASE_URL</span> + <span class="type">ITEM_DESC_URL</span> + itemId);</span><br><span class="line">			//转换成java对象</span><br><span class="line">			<span class="type">TaotaoResult</span> taotaoResult = <span class="type">TaotaoResult</span>.formatToPojo(json, <span class="type">TbItemDesc</span>.class);</span><br><span class="line">			<span class="keyword">if</span> (taotaoResult.getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">				<span class="type">TbItemDesc</span> itemDesc = (<span class="type">TbItemDesc</span>) taotaoResult.getData();</span><br><span class="line">				//取商品描述信息</span><br><span class="line">				<span class="type">String</span> <span class="literal">result</span> = itemDesc.getItemDesc();</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> ItemController &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ItemService itemService;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">@RequestMapping</span>(<span class="string">"/item/&#123;itemId&#125;"</span>)</span><br><span class="line">	<span class="keyword">public</span> String getItem(<span class="keyword">@PathVariable</span> Long itemId, Model model)&#123;</span><br><span class="line">		ItemInfo itemInfo = itemService.getItemById(itemId);</span><br><span class="line">		</span><br><span class="line">		model.addAttribute(<span class="string">"item"</span>, itemInfo);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"item"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">@RequestMapping</span>(value=<span class="string">"/item/desc/&#123;itemId&#125;"</span>, produces=MediaType.TEXT_HTML_VALUE+<span class="string">";charset=utf-8"</span>)</span><br><span class="line">	<span class="keyword">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> String getItemDesc(<span class="keyword">@PathVariable</span> Long itemId) &#123;</span><br><span class="line">		String <span class="built_in">string</span> = itemService.getItemDescById(itemId);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/rest_item_detail_service.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/22/Java项目实战-solr实现前端商品搜索/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/Java项目实战-solr实现前端商品搜索/" itemprop="url">Java项目实战 - solr实现前端商品搜索</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-22T21:49:11+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/22/Java项目实战-solr实现前端商品搜索/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/22/Java项目实战-solr实现前端商品搜索/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在zheyi-portal工程中实现。</p>
<h1 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h1><p>无。</p>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Service</span></span><br><span class="line">public class <span class="type">SearchServiceImpl</span> implements <span class="type">SearchService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Value</span>(<span class="string">"$&#123;SEARCH_BASE_URL&#125;"</span>)</span><br><span class="line">	private <span class="type">String</span> <span class="type">SEARCH_BASE_URL</span>;</span><br><span class="line"></span><br><span class="line">	@<span class="type">Override</span></span><br><span class="line">	public <span class="type">SearchResult</span> search(<span class="type">String</span> query, <span class="type">int</span> page) &#123;</span><br><span class="line">		<span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; param = new <span class="type">HashMap</span>&lt;&gt;();</span><br><span class="line">		param.put(<span class="string">"q"</span>, query);</span><br><span class="line">		param.put(<span class="string">"page"</span>, page + <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">String</span> getString = <span class="type">HttpClientUtil</span>.doGet(<span class="type">SEARCH_BASE_URL</span>, param);</span><br><span class="line">			<span class="type">TaotaoResult</span> <span class="literal">result</span> = <span class="type">TaotaoResult</span>.formatToPojo(getString, <span class="type">SearchResult</span>.class);</span><br><span class="line">			<span class="keyword">if</span> (<span class="literal">result</span>.getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">				<span class="type">SearchResult</span> searchResult = (<span class="type">SearchResult</span>) <span class="literal">result</span>.getData();</span><br><span class="line">				<span class="keyword">return</span> searchResult;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Controller</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SearchServiceController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	private SearchService searchService;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@RequestMapping</span>(<span class="string">"/search"</span>)</span><br><span class="line">	public <span class="built_in">String</span> search(<span class="annotation">@RequestParam</span>(<span class="string">"q"</span>)<span class="built_in">String</span> query, <span class="annotation">@RequestParam</span>(defaultValue=<span class="string">"1"</span>)Integer page, </span><br><span class="line">			Model model) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (query != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				query = <span class="keyword">new</span> <span class="built_in">String</span>(query.getBytes(<span class="string">"iso8859-1"</span>), <span class="string">"utf-8"</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		SearchResult searchResult = searchService.search(query, page);</span><br><span class="line">		</span><br><span class="line">		model.addAttribute(<span class="string">"query"</span>, query);</span><br><span class="line">		model.addAttribute(<span class="string">"totalPages"</span>, searchResult.getTotalPageCount());</span><br><span class="line">		model.addAttribute(<span class="string">"itemList"</span>, searchResult.getItemList());</span><br><span class="line">		model.addAttribute(<span class="string">"page"</span>, page);</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"search"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/22/Java项目实战-solr发布搜索服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/Java项目实战-solr发布搜索服务/" itemprop="url">Java项目实战 - solr发布搜索服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-22T17:34:20+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/22/Java项目实战-solr发布搜索服务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/22/Java项目实战-solr发布搜索服务/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>发布搜索服务供其它工程调用。</p>
<h1 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h1><p>要定义返回的POJO：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchResult</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">List</span>&lt;Item&gt; itemList;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> totalItemCount;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> totalPageCount;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> currentPageNumber;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> currentRowCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>并实现Dao:<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Repository</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SearchDaoImpl</span> <span class="keyword">implements</span> <span class="title">SearchDao</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	private SolrServer solrServer;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	public SearchResult search(SolrQuery query) throws Exception &#123;</span><br><span class="line">		<span class="comment">// return result</span></span><br><span class="line">		SearchResult resultList = <span class="keyword">new</span> SearchResult();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// solr search</span></span><br><span class="line">		QueryResponse response =  solrServer.query(query);</span><br><span class="line">		SolrDocumentList solrDocumentList = response.getResults();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// highlight</span></span><br><span class="line">		<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt;&gt;&gt; highlighting = response.getHighlighting();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//get item list</span></span><br><span class="line">		<span class="built_in">List</span>&lt;Item&gt; itemList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (SolrDocument solrDocument : solrDocumentList) &#123;</span><br><span class="line">			Item item = <span class="keyword">new</span> Item();</span><br><span class="line">			</span><br><span class="line">			item.setId((<span class="built_in">String</span>) solrDocument.<span class="literal">get</span>(<span class="string">"id"</span>));</span><br><span class="line">			<span class="comment">//get highlight</span></span><br><span class="line">			<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; list = highlighting.<span class="literal">get</span>(solrDocument.<span class="literal">get</span>(<span class="string">"id"</span>)).<span class="literal">get</span>(<span class="string">"item_title"</span>);</span><br><span class="line">			<span class="built_in">String</span> title = <span class="string">""</span>;</span><br><span class="line">			<span class="keyword">if</span>(list != <span class="keyword">null</span> &amp;&amp; list.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				title = list.<span class="literal">get</span>(<span class="number">0</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				title = (<span class="built_in">String</span>) solrDocument.<span class="literal">get</span>(<span class="string">"item_title"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			item.setTitle(title);</span><br><span class="line">			item.setImage((<span class="built_in">String</span>) solrDocument.<span class="literal">get</span>(<span class="string">"item_image"</span>));</span><br><span class="line">			item.setPrice((long) solrDocument.<span class="literal">get</span>(<span class="string">"item_price"</span>));</span><br><span class="line">			item.setSell_point((<span class="built_in">String</span>) solrDocument.<span class="literal">get</span>(<span class="string">"item_sell_point"</span>));</span><br><span class="line">			item.setCategory_name((<span class="built_in">String</span>) solrDocument.<span class="literal">get</span>(<span class="string">"item_category_name"</span>));</span><br><span class="line">			</span><br><span class="line">			itemList.add(item);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		resultList.setItemList(itemList);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// get total item number</span></span><br><span class="line">		resultList.setTotalItemCount(solrDocumentList.getNumFound());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> resultList;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Service</span></span><br><span class="line">public class <span class="type">ServiceSearchImpl</span> implements <span class="type">SearchService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Autowired</span></span><br><span class="line">	private <span class="type">SearchDao</span> searchDao;</span><br><span class="line"></span><br><span class="line">	@<span class="type">Override</span></span><br><span class="line">	public <span class="type">SearchResult</span> search(<span class="type">String</span> query, <span class="type">int</span> page, <span class="type">int</span> rows) throws <span class="type">Exception</span> &#123;</span><br><span class="line">		<span class="type">SolrQuery</span> solrQuery = new <span class="type">SolrQuery</span>();</span><br><span class="line">		</span><br><span class="line">		solrQuery.setQuery(query);</span><br><span class="line">		</span><br><span class="line">		solrQuery.setStart((page -<span class="number">1</span>) * rows);</span><br><span class="line">		solrQuery.setRows(rows);</span><br><span class="line">		</span><br><span class="line">		solrQuery.<span class="type">set</span>(<span class="string">"df"</span>, <span class="string">"item_keywords"</span>);</span><br><span class="line">		</span><br><span class="line">		solrQuery.setHighlight(<span class="literal">true</span>);</span><br><span class="line">		solrQuery.addHighlightField(<span class="string">"item_title"</span>);</span><br><span class="line">		solrQuery.setHighlightSimplePre(<span class="string">"&lt;em style=\"color:red\"&gt;"</span>);</span><br><span class="line">		solrQuery.setHighlightSimplePost(<span class="string">"&lt;/em&gt;"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="type">SearchResult</span> <span class="literal">result</span> = searchDao.search(solrQuery);</span><br><span class="line">		</span><br><span class="line">		long totalItemCount = <span class="literal">result</span>.getTotalItemCount();</span><br><span class="line">		long totalPageCount = totalItemCount / rows;</span><br><span class="line">		<span class="keyword">if</span> (totalItemCount % rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">			totalPageCount++;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="literal">result</span>.setTotalPageCount(totalPageCount);</span><br><span class="line">		<span class="literal">result</span>.setCurrentPageNumber(page);</span><br><span class="line">		<span class="literal">result</span>.setCurrentRowCount(rows);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchServiceController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SearchService searchService;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@RequestMapping</span>(value=<span class="string">"/query"</span>, method=RequestMethod.GET)</span><br><span class="line">	<span class="annotation">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> TaotaoResult search(<span class="annotation">@RequestParam</span>(<span class="string">"q"</span>)String query, </span><br><span class="line">			<span class="annotation">@RequestParam</span>(defaultValue=<span class="string">"1"</span>)Integer page,</span><br><span class="line">			<span class="annotation">@RequestParam</span>(defaultValue=<span class="string">"20"</span>)Integer rows)&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//query is null</span></span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isBlank(query))</span><br><span class="line">			<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">build</span><span class="params">(<span class="number">400</span>, <span class="string">"Should contain query string"</span>)</span></span>;</span><br><span class="line">		</span><br><span class="line">		SearchResult searchResult = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			query = <span class="keyword">new</span> String(query.getBytes(<span class="string">"iso8859-1"</span>), <span class="string">"utf-8"</span>);</span><br><span class="line">			searchResult = searchService.search(query, page, rows);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">(searchResult)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/solr_search_service.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/22/Java项目实战-solr导入索引库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/Java项目实战-solr导入索引库/" itemprop="url">Java项目实战 - solr导入索引库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-22T17:33:57+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/22/Java项目实战-solr导入索引库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/22/Java项目实战-solr导入索引库/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实现：<br>使用java程序读取mysql数据库中的商品信息，然后创建solr文档对象，把商品信息写入索引库。</p>
<h1 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h1><p>多表查询，要创建相应的POJO和Mapper。<br>POJO:<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Item &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> id;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> title;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> sell_point;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> price;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> <span class="built_in">image</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> category_name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">String</span> item_des;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Mapper:<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">interface</span> <span class="title">ItemMapper</span> </span>&#123;</span><br><span class="line">	<span class="built_in">List</span>&lt;Item&gt; getItemList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="doctype">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">mapper</span> <span class="attribute">namespace</span>=<span class="value">"com.izheyi.search.mapper.ItemMapper"</span> &gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="title">select</span> <span class="attribute">id</span>=<span class="value">"getItemList"</span> <span class="attribute">resultType</span>=<span class="value">"com.izheyi.search.pojo.Item"</span>&gt;</span></span><br><span class="line">		SELECT</span><br><span class="line">			a.id,</span><br><span class="line">			a.title,</span><br><span class="line">			a.sell_point,</span><br><span class="line">			a.price,</span><br><span class="line">			a.image,</span><br><span class="line">			b. NAME category_name</span><br><span class="line">		FROM</span><br><span class="line">			tb_item a</span><br><span class="line">		LEFT JOIN tb_item_cat b ON a.cid = b.id</span><br><span class="line">	<span class="tag">&lt;/<span class="title">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceImpl</span> <span class="keyword">implements</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	private ItemMapper itemMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	private SolrServer solrServer;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	public TaotaoResult importItemsToSolr() &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//查询商品列表</span></span><br><span class="line">			<span class="built_in">List</span>&lt;Item&gt; list = itemMapper.getItemList();</span><br><span class="line">			<span class="comment">//把商品信息写入索引库</span></span><br><span class="line">			<span class="keyword">for</span> (Item item : list) &#123;</span><br><span class="line">				<span class="comment">//创建一个SolrInputDocument对象</span></span><br><span class="line">				SolrInputDocument <span class="built_in">document</span> = <span class="keyword">new</span> SolrInputDocument();</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"id"</span>, item.getId());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_title"</span>, item.getTitle());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_sell_point"</span>, item.getSell_point());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_price"</span>, item.getPrice());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_image"</span>, item.getImage());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_category_name"</span>, item.getCategory_name());</span><br><span class="line">				<span class="built_in">document</span>.setField(<span class="string">"item_desc"</span>, item.getItem_des());</span><br><span class="line">				<span class="comment">//写入索引库</span></span><br><span class="line">				solrServer.add(<span class="built_in">document</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//提交修改</span></span><br><span class="line">			solrServer.commit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> TaotaoResult.build(<span class="number">500</span>, ExceptionUtil.getStackTrace(e));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> TaotaoResult.ok();</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要配置applicationContext-solr.xml。</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Controller</span></span><br><span class="line">@<span class="type">RequestMapping</span>(<span class="string">"/manager"</span>)</span><br><span class="line">public class <span class="type">ItemController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Autowired</span> <span class="type">ItemService</span> itemService;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">RequestMapping</span>(<span class="string">"/import"</span>)</span><br><span class="line">	@<span class="type">ResponseBody</span></span><br><span class="line">	public <span class="type">TaotaoResult</span> importItemsToSolr()&#123;</span><br><span class="line">		<span class="type">TaotaoResult</span> <span class="literal">result</span> = itemService.importItemsToSolr();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/javaproject/solr_import.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/22/Java项目实战-solr安装与配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/22/Java项目实战-solr安装与配置/" itemprop="url">Java项目实战 - solr安装与配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-22T09:12:51+08:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/22/Java项目实战-solr安装与配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/22/Java项目实战-solr安装与配置/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Solr是一个全文检索服务器，只需要进行配置就可以实现全文检索服务。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol>
<li>前提，有JDK和Tomcat。</li>
<li>下载solr的安装包，解压，并把dist下的war包部署到Tomcat下。</li>
<li>解压war包。启动tomcat自动解压。</li>
<li>把solr/example/lib/ext目录下所有的jar包复制Tomcat下/webapps/solr/WEB-INF/lib/。</li>
<li>创建solrhome，把example/sor复制到/opt/solrhome。</li>
<li>配置solrhome，在/apache-tomcat-8.0.28/webapps/solr/WEB-INF/web.xml。</li>
<li>启动Tomcat。<br><img src="/images/javaproject/solr.jpg" alt=""></li>
</ol>
<h1 id="中文分析器IK-Analyzer"><a href="#中文分析器IK-Analyzer" class="headerlink" title="中文分析器IK-Analyzer"></a>中文分析器IK-Analyzer</h1><p>Solr中默认是没有中文分析器的，需要手工配置，配置一个FieldType，在FieldType中指定使用的中文分析器。</p>
<ol>
<li>下载包。</li>
<li>把中文分析器的jar复制到Tomcat下/webapps/solr/WEB-INF/lib/。</li>
<li>把IK Analyzer需要的扩展词典及停用词词典、配置文件复制到Tomcat下/webapps/solr/WEB-INF/classes。</li>
<li>在solrhome/collection1/conf/schema.xml中配置FileType。</li>
</ol>
<h1 id="配置业务域"><a href="#配置业务域" class="headerlink" title="配置业务域"></a>配置业务域</h1><p>就是配置要搜索的字段，和后续用到的字段。<br>业务系统Fileds：<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;field name=<span class="string">"item_title"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text_ik"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;field name=<span class="string">"item_sell_point"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text_ik"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;field name=<span class="string">"item_price"</span>  <span class="class"><span class="keyword">type</span></span>=<span class="string">"long"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;field name=<span class="string">"item_image"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"string"</span> indexed=<span class="string">"false"</span> stored=<span class="string">"true"</span> /&gt;</span><br><span class="line">&lt;field name=<span class="string">"item_category_name"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"string"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"true"</span> /&gt;</span><br><span class="line">&lt;field name=<span class="string">"item_desc"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text_ik"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"false"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;field name=<span class="string">"item_keywords"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text_ik"</span> indexed=<span class="string">"true"</span> stored=<span class="string">"false"</span> multiValued=<span class="string">"true"</span>/&gt;</span><br><span class="line">&lt;copyField source=<span class="string">"item_title"</span> dest=<span class="string">"item_keywords"</span>/&gt;</span><br><span class="line">&lt;copyField source=<span class="string">"item_sell_point"</span> dest=<span class="string">"item_keywords"</span>/&gt;</span><br><span class="line">&lt;copyField source=<span class="string">"item_category_name"</span> dest=<span class="string">"item_keywords"</span>/&gt;</span><br><span class="line">&lt;copyField source=<span class="string">"item_desc"</span> dest=<span class="string">"item_keywords"</span>/&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/javaproject/solr_config.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/21/Java项目实战-Redis缓存同步/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/Java项目实战-Redis缓存同步/" itemprop="url">Java项目实战 - Redis缓存同步</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-21T18:01:49+08:00">
                2018-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/21/Java项目实战-Redis缓存同步/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/21/Java项目实战-Redis缓存同步/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>缓存有个问题就是如果数据库表中的数据做了修改，缓存是需要同步的，否则查询的还是老数据，所有涉及增、删、改的操作都需要同步缓存。</p>
<p>我们创建一个rest服务供manager-service层调用。</p>
<h1 id="Redis-Service"><a href="#Redis-Service" class="headerlink" title="Redis Service"></a>Redis Service</h1><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedisService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Value</span>(<span class="string">"$&#123;CONTENT_KEY&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> String CONTENT_KEY;</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function">TaotaoResult <span class="title">syncContent</span><span class="params">(<span class="keyword">long</span> contentCategoryId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			redisUtils.hdel(CONTENT_KEY, contentCategoryId + <span class="string">""</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">()</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Redis-Controller"><a href="#Redis-Controller" class="headerlink" title="Redis Controller"></a>Redis Controller</h1><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Controller</span></span><br><span class="line">@<span class="type">RequestMapping</span>(<span class="string">"/cache"</span>)</span><br><span class="line">public class <span class="type">RedisController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">Autowired</span></span><br><span class="line">	private <span class="type">RedisService</span> redisService;</span><br><span class="line">	</span><br><span class="line">	@<span class="type">RequestMapping</span>(<span class="string">"/content/&#123;contentCategoryId&#125;"</span>)</span><br><span class="line">	@<span class="type">ResponseBody</span></span><br><span class="line">	public <span class="type">TaotaoResult</span> syncContent(@<span class="type">PathVariable</span> long contentCategoryId) &#123;</span><br><span class="line">		<span class="type">TaotaoResult</span> <span class="literal">result</span> = redisService.syncContent(contentCategoryId);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Content-Service"><a href="#Content-Service" class="headerlink" title="Content Service"></a>Content Service</h1><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">TaotaoResult <span class="title">createContent</span><span class="params">(TbContent tbContent)</span> </span>&#123;</span><br><span class="line">	tbContent.setCreated(<span class="keyword">new</span> Date());</span><br><span class="line">	tbContent.setUpdated(<span class="keyword">new</span> Date());</span><br><span class="line">	</span><br><span class="line">	contentMapper.insert(tbContent);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//添加缓存同步</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		HttpClientUtil.doGet(REST_BASE_URL + REST_CONTENT_SYNC_URL + tbContent.getCategoryId());</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">return</span> TaotaoResult.<span class="title">ok</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Verify"><a href="#Verify" class="headerlink" title="Verify"></a>Verify</h1><p>在后台添加一个Content，删除缓存。<br><img src="/images/javaproject/redis_result.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/21/Java项目实战-Redis集成Spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/Java项目实战-Redis集成Spring/" itemprop="url">Java项目实战 - Redis集成Spring</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-21T18:00:11+08:00">
                2018-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/21/Java项目实战-Redis集成Spring/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/21/Java项目实战-Redis集成Spring/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一般只会在生产环境使用集群，而开发环境使用Redis单机版，所以我们在整合项目的时候，单机版和集群版都要有。</p>
<h1 id="Spring整合Redis"><a href="#Spring整合Redis" class="headerlink" title="Spring整合Redis"></a>Spring整合Redis</h1><p>创建一个接口，再编写单机版和集群版的实现类，使用spring进行管理，在部署时，使用哪种Redis，就切换那种实现类。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>Interface:<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.izheyi.rest.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> interface RedisUtils &#123;</span><br><span class="line">	<span class="keyword">String</span> <span class="built_in">set</span>(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> value);</span><br><span class="line">    <span class="keyword">String</span> <span class="built_in">get</span>(<span class="keyword">String</span> <span class="variable">key</span>);</span><br><span class="line">    Boolean exists(<span class="keyword">String</span> <span class="variable">key</span>);</span><br><span class="line">    Long expire(<span class="keyword">String</span> <span class="variable">key</span>, <span class="built_in">int</span> seconds);</span><br><span class="line">    Long ttl(<span class="keyword">String</span> <span class="variable">key</span>);</span><br><span class="line">    Long incr(<span class="keyword">String</span> <span class="variable">key</span>);</span><br><span class="line">    Long hset(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> field, <span class="keyword">String</span> value);</span><br><span class="line">    <span class="keyword">String</span> hget(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> field);</span><br><span class="line">    Long hdel(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span>... field);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单机版：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">public class <span class="type">RedisPool</span> implements <span class="type">RedisUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">	@<span class="type">Autowired</span></span><br><span class="line">    private <span class="type">JedisPool</span> jedisPool;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">String</span> <span class="type">set</span>(<span class="type">String</span> key, <span class="type">String</span> value) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">String</span> <span class="literal">result</span> = jedis.<span class="type">set</span>(key, value);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">String</span> get(<span class="type">String</span> key) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">String</span> <span class="literal">result</span> = jedis.get(key);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Boolean</span> exists(<span class="type">String</span> key) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Boolean</span> <span class="literal">result</span> = jedis.exists(key);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Long</span> expire(<span class="type">String</span> key, <span class="type">int</span> seconds) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Long</span> <span class="literal">result</span> = jedis.expire(key, seconds);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Long</span> ttl(<span class="type">String</span> key) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Long</span> <span class="literal">result</span> = jedis.ttl(key);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Long</span> incr(<span class="type">String</span> key) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Long</span> <span class="literal">result</span> = jedis.incr(key);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Long</span> hset(<span class="type">String</span> key, <span class="type">String</span> field, <span class="type">String</span> value) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Long</span> <span class="literal">result</span> = jedis.hset(key, field, value);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">String</span> hget(<span class="type">String</span> key, <span class="type">String</span> field) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">String</span> <span class="literal">result</span> = jedis.hget(key, field);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="type">Override</span></span><br><span class="line">    public <span class="type">Long</span> hdel(<span class="type">String</span> key, <span class="type">String</span>... field) &#123;</span><br><span class="line">        <span class="type">Jedis</span> jedis = jedisPool.getResource();</span><br><span class="line">        <span class="type">Long</span> <span class="literal">result</span> = jedis.hdel(key, field);</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>集群版：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class RedisCluster implements RedisUtils &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">    <span class="keyword">private</span> JedisCluster jedisCluster;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> <span class="built_in">set</span>(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> value) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.<span class="built_in">set</span>(<span class="variable">key</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> <span class="built_in">get</span>(<span class="keyword">String</span> <span class="variable">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.<span class="built_in">get</span>(<span class="variable">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Boolean exists(<span class="keyword">String</span> <span class="variable">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.exists(<span class="variable">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Long expire(<span class="keyword">String</span> <span class="variable">key</span>, <span class="built_in">int</span> seconds) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.expire(<span class="variable">key</span>, seconds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Long ttl(<span class="keyword">String</span> <span class="variable">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.ttl(<span class="variable">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Long incr(<span class="keyword">String</span> <span class="variable">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.incr(<span class="variable">key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Long hset(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> field, <span class="keyword">String</span> value) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.hset(<span class="variable">key</span>, field, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> hget(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span> field) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.hget(<span class="variable">key</span>, field);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Long hdel(<span class="keyword">String</span> <span class="variable">key</span>, <span class="keyword">String</span>... field) &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisCluster.hdel(<span class="variable">key</span>, field);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="applicationContext-redis-xml"><a href="#applicationContext-redis-xml" class="headerlink" title="applicationContext-redis.xml"></a>applicationContext-redis.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 两种方案：使用jedis连接池(单机版)和jedis集群 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一般生产环境使用集群，开发环境使用单机版 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用哪种，可以将另一种注释掉 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 单机版 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置jedis连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.JedisPool"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;redis.host&#125;"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;redis.port&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集群版 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置jedis集群 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.JedisCluster"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"nodes"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host1&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port1&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host2&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port2&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host3&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port3&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host4&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port4&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host5&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port5&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">class</span>=<span class="value">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"host"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.host6&#125;"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"port"</span> <span class="attribute">value</span>=<span class="value">"$&#123;cluster.port6&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="添加到业务中"><a href="#添加到业务中" class="headerlink" title="添加到业务中"></a>添加到业务中</h1><p>缓存的添加不能影响正常的业务逻辑。</p>
<p>以首页大广告位的展示为例。在请求的时候如果有缓存，就直接响应；如果没有，就从DB中读取，并写入到缓存中，再响应。<br>对获得大广告位的Service进行修改：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public <span class="type">List</span>&lt;<span class="type">TbContent</span>&gt; getContentList(long contentCategoryId) &#123;</span><br><span class="line">		// 查询数据库之前，先查询缓存</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="type">String</span> json = redisUtils.hget(<span class="type">CONTENT_KEY</span>, contentCategoryId + <span class="string">""</span>);</span><br><span class="line">	        // 判断是否命中缓存</span><br><span class="line">	        <span class="keyword">if</span> (<span class="type">StringUtils</span>.isNotBlank(json)) &#123;</span><br><span class="line">	            // 把这个json转换成<span class="type">List</span>集合</span><br><span class="line">	            <span class="type">List</span>&lt;<span class="type">TbContent</span>&gt; list = <span class="type">JsonUtils</span>.jsonToList(json, <span class="type">TbContent</span>.class);</span><br><span class="line">	            <span class="keyword">return</span> list;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">	        e.printStackTrace();</span><br><span class="line">	    &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="type">TbContentExample</span> example = new <span class="type">TbContentExample</span>();</span><br><span class="line">		<span class="type">Criteria</span> criteria = example.createCriteria();</span><br><span class="line">		criteria.andCategoryIdEqualTo(contentCategoryId);</span><br><span class="line">		</span><br><span class="line">		<span class="type">List</span>&lt;<span class="type">TbContent</span>&gt; <span class="literal">result</span> = contentMapper.selectByExample(example);</span><br><span class="line">		</span><br><span class="line">		// 添加缓存，并且不能影响正常业务逻辑</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	    	redisUtils.hset(<span class="type">CONTENT_KEY</span>, contentCategoryId + <span class="string">""</span>, <span class="type">JsonUtils</span>.objectToJson(<span class="literal">result</span>));</span><br><span class="line">	    &#125; catch (<span class="type">Exception</span> e) &#123;</span><br><span class="line">	        e.printStackTrace();</span><br><span class="line">	    &#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>刷新首页，检查redis缓存。<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hget CONTENT_KEY 89</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; hget CONTENT_KEY 89</span><br><span class="line">"<span class="special">[</span><span class="special">&#123;</span><span class="command">\"</span>id<span class="command">\"</span>:33,<span class="command">\"</span>categoryId<span class="command">\"</span>:89,<span class="command">\"</span>title<span class="command">\"</span>:<span class="command">\"</span>ad1<span class="command">\"</span>,<span class="command">\"</span>subTitle<span class="command">\"</span>:<span class="command">\"</span>ad1<span class="command">\"</span>,<span class="command">\"</span>titleDesc<span class="command">\"</span>:<span class="command">\"</span>ad1<span class="command">\"</span>,<span class="command">\"</span>url<span class="command">\"</span>:<span class="command">\"</span>http://google.com<span class="command">\"</span>,<span class="command">\"</span>pic<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/c7ae33f0-1e56-451c-94b3-a7cc5dbd5101.jpg<span class="command">\"</span>,<span class="command">\"</span>pic2<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/f7622208-d7df-4a95-b279-69e48c148fdf.jpg<span class="command">\"</span>,<span class="command">\"</span>created<span class="command">\"</span>:1531905943000,<span class="command">\"</span>updated<span class="command">\"</span>:1531905943000,<span class="command">\"</span>content<span class="command">\"</span>:null<span class="special">&#125;</span>,<span class="special">&#123;</span><span class="command">\"</span>id<span class="command">\"</span>:34,<span class="command">\"</span>categoryId<span class="command">\"</span>:89,<span class="command">\"</span>title<span class="command">\"</span>:<span class="command">\"</span>ad2<span class="command">\"</span>,<span class="command">\"</span>subTitle<span class="command">\"</span>:<span class="command">\"</span>ad2<span class="command">\"</span>,<span class="command">\"</span>titleDesc<span class="command">\"</span>:<span class="command">\"</span>ad2<span class="command">\"</span>,<span class="command">\"</span>url<span class="command">\"</span>:<span class="command">\"</span><span class="special">#</span><span class="command">\"</span>,<span class="command">\"</span>pic<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/b83eae10-105e-4fa4-8b46-26f16114c11b.jpg<span class="command">\"</span>,<span class="command">\"</span>pic2<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/7dec8ede-5fae-4e80-90cc-15a6a7781355.jpg<span class="command">\"</span>,<span class="command">\"</span>created<span class="command">\"</span>:1531905966000,<span class="command">\"</span>updated<span class="command">\"</span>:1531905966000,<span class="command">\"</span>content<span class="command">\"</span>:null<span class="special">&#125;</span>,<span class="special">&#123;</span><span class="command">\"</span>id<span class="command">\"</span>:35,<span class="command">\"</span>categoryId<span class="command">\"</span>:89,<span class="command">\"</span>title<span class="command">\"</span>:<span class="command">\"</span>ad3<span class="command">\"</span>,<span class="command">\"</span>subTitle<span class="command">\"</span>:<span class="command">\"</span>ad3<span class="command">\"</span>,<span class="command">\"</span>titleDesc<span class="command">\"</span>:<span class="command">\"</span>ad3<span class="command">\"</span>,<span class="command">\"</span>url<span class="command">\"</span>:<span class="command">\"</span>ad3<span class="command">\"</span>,<span class="command">\"</span>pic<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/7adf566c-2967-4e99-9265-283244d3379d.jpg<span class="command">\"</span>,<span class="command">\"</span>pic2<span class="command">\"</span>:<span class="command">\"</span>http://192.168.220.133/images/2018/07/18/2381bf63-2b89-40ad-858c-498ea01e5abf.jpg<span class="command">\"</span>,<span class="command">\"</span>created<span class="command">\"</span>:1531905995000,<span class="command">\"</span>updated<span class="command">\"</span>:1531905995000,<span class="command">\"</span>content<span class="command">\"</span>:null<span class="special">&#125;</span><span class="special">]</span>"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://izheyi.com/2018/07/21/Java项目实战-Redis安装和集群搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="唐胡璐">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YONGFEIUALL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/21/Java项目实战-Redis安装和集群搭建/" itemprop="url">Java项目实战 - Redis安装和集群搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-21T15:04:08+08:00">
                2018-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/21/Java项目实战-Redis安装和集群搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/07/21/Java项目实战-Redis安装和集群搭建/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis是用C语言开发的一个开源的高性能键值对（key-value）数据库。它通过提供多种键值数据类型来适应不同场景下的存储需求，目前为止Redis支持的键值数据类型如下：</p>
<ul>
<li>字符串类型</li>
<li>散列类型</li>
<li>列表类型</li>
<li>集合类型</li>
<li>有序集合类型</li>
</ul>
<p>详细内容，参考：<a href="https://redis.io/" target="_blank" rel="external">Redis</a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>安装还是很简单的，如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http:<span class="comment">//download.redis.io/releases/redis-4.0.10.tar.gz</span></span><br><span class="line">$ tar xzf redis-<span class="number">4.0</span><span class="number">.10</span>.tar.gz</span><br><span class="line">$ cd redis-<span class="number">4.0</span><span class="number">.10</span></span><br><span class="line">$ make</span><br></pre></td></tr></table></figure></p>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><ol>
<li><p>直接启动</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-4.0.10]# src/redis-server </span><br><span class="line">9833:C 13 Jun 23:58:18.056 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">9833:C 13 Jun 23:58:18.056 # Redis version=4.0.10, bits=64, <span class="operator"><span class="keyword">commit</span>=<span class="number">00000000</span>, modified=<span class="number">0</span>, pid=<span class="number">9833</span>, just started</span><br><span class="line"><span class="number">9833</span>:<span class="keyword">C</span> <span class="number">13</span> Jun <span class="number">23</span>:<span class="number">58</span>:<span class="number">18.056</span> # <span class="keyword">Warning</span>: <span class="keyword">no</span> config <span class="keyword">file</span> specified, <span class="keyword">using</span> the <span class="keyword">default</span> config. <span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> specify a config <span class="keyword">file</span> <span class="keyword">use</span> src/redis-<span class="keyword">server</span> /<span class="keyword">path</span>/<span class="keyword">to</span>/redis.conf</span><br><span class="line"><span class="number">9833</span>:<span class="keyword">M</span> <span class="number">13</span> Jun <span class="number">23</span>:<span class="number">58</span>:<span class="number">18.058</span> * Increased maximum <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">open</span> files <span class="keyword">to</span> <span class="number">10032</span> (it was originally <span class="keyword">set</span> <span class="keyword">to</span> <span class="number">1024</span>).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-<span class="string">``</span>__ <span class="string">''</span>-._                                             </span><br><span class="line">      _.-<span class="string">``</span>    <span class="string">`.  `</span>_.  <span class="string">''</span>-._           Redis <span class="number">4.0</span><span class="number">.10</span> (<span class="number">00000000</span>/<span class="number">0</span>) <span class="number">64</span> <span class="built_in">bit</span></span><br><span class="line">  .-<span class="string">``</span> .-<span class="string">``</span><span class="string">`.  `</span><span class="string">``</span>\/    _.,_ <span class="string">''</span>-._                                   </span><br><span class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|'</span><span class="string">` _.-'|     Port: 6379</span><br><span class="line"> |    `</span>-._   <span class="string">`._    /     _.-'    |     PID: 9833</span><br><span class="line">  `</span>-._    <span class="string">`-._  `</span>-./  _.-<span class="string">'    _.-'</span>                                   </span><br><span class="line"> |<span class="string">`-._`</span>-._    <span class="string">`-.__.-'    _.-'_.-'|                                  </span><br><span class="line"> |    `</span>-._<span class="string">`-._        _.-'_.-'    |           http://redis.io        </span><br><span class="line">  `</span>-._    <span class="string">`-._`</span>-.__.-<span class="string">'_.-'</span>    _.-<span class="string">'                                   </span><br><span class="line"> |`-._`-._    `-.__.-'</span>    _.-<span class="string">'_.-'</span>|                                  </span><br><span class="line"> |    <span class="string">`-._`</span>-._        _.-<span class="string">'_.-'</span>    |                                  </span><br><span class="line">  <span class="string">`-._    `</span>-._<span class="string">`-.__.-'_.-'    _.-'                                   </span><br><span class="line">      `</span>-._    <span class="string">`-.__.-'    _.-'                                       </span><br><span class="line">          `</span>-._        _.-<span class="string">'                                           </span><br><span class="line">              `-.__.-'</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>指定配置文件启动<br>把redis的解压缩目录的redis.conf文件复制一份到/usr/local/redis/bin目录下</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-<span class="number">4.0</span><span class="number">.10</span>]<span class="preprocessor"># src/redis-server redis.conf </span></span><br><span class="line"><span class="number">12033</span>:C <span class="number">14</span> Jun <span class="number">00</span>:<span class="number">15</span>:<span class="number">48.382</span> <span class="preprocessor"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line"><span class="number">12033</span>:C <span class="number">14</span> Jun <span class="number">00</span>:<span class="number">15</span>:<span class="number">48.383</span> <span class="preprocessor"># Redis version=<span class="number">4.0</span><span class="number">.10</span>, bits=<span class="number">64</span>, commit=<span class="number">00000000</span>, modified=<span class="number">0</span>, pid=<span class="number">12033</span>, just started</span></span><br><span class="line"><span class="number">12033</span>:C <span class="number">14</span> Jun <span class="number">00</span>:<span class="number">15</span>:<span class="number">48.383</span> <span class="preprocessor"># Configuration loaded</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-<span class="number">4.0</span><span class="number">.10</span>]<span class="preprocessor"># src/redis-cli </span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> a <span class="number">10</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get a</span><br><span class="line"><span class="string">"10"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-<span class="number">4.0</span><span class="number">.10</span>]<span class="preprocessor"># src/redis-cli shutdown</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h1><h2 id="需要安装以下环境"><a href="#需要安装以下环境" class="headerlink" title="需要安装以下环境"></a>需要安装以下环境</h2><ul>
<li>ruby的环境：yum install ruby</li>
<li>rubygems组件：yum install rubygems</li>
<li>redis和ruby的接口：gem install redis</li>
</ul>
<h2 id="在同一台机器上搭建环境"><a href="#在同一台机器上搭建环境" class="headerlink" title="在同一台机器上搭建环境"></a>在同一台机器上搭建环境</h2><ol>
<li>在<code>/usr/local/</code>下创建文件夹redis-cluster</li>
<li><p>为每个实例创建一个文件夹，共6个</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-cluster]<span class="preprocessor"># ls</span></span><br><span class="line"><span class="number">7001</span>  <span class="number">7002</span>  <span class="number">7003</span>  <span class="number">7004</span>  <span class="number">7005</span>  <span class="number">7006</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>把redis安装目录bin Copy到6个文件夹</p>
</li>
<li>修改每个实例<ol>
<li>Port 7001 - 7006</li>
<li>屏蔽限制本地访问,在bind 127.0.0.1之前加#</li>
<li>protected-mode后的yes改为no</li>
<li>daemonize后的no改为yes</li>
<li>去掉cluster-enabled前面的#</li>
<li>去掉cluster-node-timeout前面的#</li>
</ol>
</li>
<li>启动6个实例 - 可以建个脚本一并启动</li>
<li>验证启动 <figure class="highlight"><figcaption><span>redis-cluster]# ps -ef | grep redis</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root     24891     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7001 [cluster]&#10;root     24896     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7002 [cluster]&#10;root     24901     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7003 [cluster]&#10;root     24906     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7004 [cluster]&#10;root     24911     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7005 [cluster]&#10;root     24913     1  0 00:05 ?        00:00:00 ./redis-server 127.0.0.1:7006 [cluster]&#10;root     24921 23221  0 00:05 pts/2    00:00:00 grep redis</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><ol>
<li><p>创建<br>把这个脚本（redis-trib.rb）从解压目录下复制到/usr/local/redis-cluster。</p>
 <figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation redis-cluster]# ./redis-trib.rb create --replicas <span class="number">1 10.24.33</span>.<span class="number">147:7001 10</span>.<span class="number">24.33.147:70</span><span class="number">02 10.24.33</span>.<span class="number">147:7003 10</span>.<span class="number">24.33.147:70</span><span class="number">04 10.24.33</span>.<span class="number">147:7005</span>  <span class="number">10.24.33.147</span>:7006</span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line"><span class="number">10.24.33.147</span>:7001</span><br><span class="line"><span class="number">10.24.33.147</span>:7002</span><br><span class="line"><span class="number">10.24.33.147</span>:7003</span><br><span class="line">Adding replica <span class="number">10.24.33.147</span>:7005 to <span class="number">10.24.33.147</span>:7001</span><br><span class="line">Adding replica <span class="number">10.24.33.147</span>:7006 to <span class="number">10.24.33.147</span>:7002</span><br><span class="line">Adding replica <span class="number">10.24.33.147</span>:7004 to <span class="number">10.24.33.147</span>:7003</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity</span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: 6d9cab<span class="number">72763d1a1</span>fe85be<span class="number">04b6448998</span>b88ea<span class="number">18a2 10.24</span>.<span class="number">33.147:7001</span></span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">M: c<span class="number">7693a9c9</span>e<span class="number">1189196481f65</span>153ed41ca9a6fe<span class="number">449 10.24</span>.<span class="number">33.147:7002</span></span><br><span class="line">   slots:<span class="number">5461-10922</span> (5462 slots) master</span><br><span class="line">M: e<span class="number">3c3977d52</span>165dcb<span class="number">589f59d16</span>a713888abdc<span class="number">0c56 10.24</span>.<span class="number">33.147:7003</span></span><br><span class="line">   slots:<span class="number">10923-16383</span> (5461 slots) master</span><br><span class="line">S: 089b61bc<span class="number">451920a7</span>a0cba<span class="number">996a4a43</span><span class="number">0b8a8805</span>c<span class="number">03 10.24.33</span>.<span class="number">147:7004</span></span><br><span class="line">   replicates e<span class="number">3c3977d52</span>165dcb<span class="number">589f59d16</span>a713888abdc0c56</span><br><span class="line">S: f<span class="number">3e9541424</span>af4fcad<span class="number">212456d2f5</span>ae<span class="number">5b6a35635</span><span class="number">25 10.24.33</span>.<span class="number">147:7005</span></span><br><span class="line">   replicates 6d9cab<span class="number">72763d1a1</span>fe85be<span class="number">04b6448998</span>b88ea18a2</span><br><span class="line">S: 0c16f9babaa8def8b721bcd<span class="number">82e43d9258</span>f<span class="number">3f68d9 10</span>.<span class="number">24.33.147:70</span>06</span><br><span class="line">   replicates c<span class="number">7693a9c9</span>e<span class="number">1189196481f65</span>153ed41ca9a6fe449</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join.....</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">10.24.33.147</span>:7001)</span><br><span class="line">M: 6d9cab<span class="number">72763d1a1</span>fe85be<span class="number">04b6448998</span>b88ea<span class="number">18a2 10.24</span>.<span class="number">33.147:7001</span></span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: f<span class="number">3e9541424</span>af4fcad<span class="number">212456d2f5</span>ae<span class="number">5b6a35635</span><span class="number">25 10.24.33</span>.<span class="number">147:7005</span></span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6d9cab<span class="number">72763d1a1</span>fe85be<span class="number">04b6448998</span>b88ea18a2</span><br><span class="line">M: e<span class="number">3c3977d52</span>165dcb<span class="number">589f59d16</span>a713888abdc<span class="number">0c56 10.24</span>.<span class="number">33.147:7003</span></span><br><span class="line">   slots:<span class="number">10923-16383</span> (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 0c16f9babaa8def8b721bcd<span class="number">82e43d9258</span>f<span class="number">3f68d9 10</span>.<span class="number">24.33.147:70</span>06</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates c<span class="number">7693a9c9</span>e<span class="number">1189196481f65</span>153ed41ca9a6fe449</span><br><span class="line">S: 089b61bc<span class="number">451920a7</span>a0cba<span class="number">996a4a43</span><span class="number">0b8a8805</span>c<span class="number">03 10.24.33</span>.<span class="number">147:7004</span></span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates e<span class="number">3c3977d52</span>165dcb<span class="number">589f59d16</span>a713888abdc0c56</span><br><span class="line">M: c<span class="number">7693a9c9</span>e<span class="number">1189196481f65</span>153ed41ca9a6fe<span class="number">449 10.24</span>.<span class="number">33.147:7002</span></span><br><span class="line">   slots:<span class="number">5461-10922</span> (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@Automation <span class="number">7001</span>]<span class="preprocessor"># redis-cli -h <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span> -p <span class="number">7001</span> -c</span></span><br><span class="line"><span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7001</span>&gt; CLUSTER NODES</span><br><span class="line">f3e9541424af4fcad212456d2f5ae5b6a3563525 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7005</span>@<span class="number">17005</span> slave <span class="number">6</span>d9cab72763d1a1fe85be04b6448998b88ea18a2 <span class="number">0</span> <span class="number">1528994341234</span> <span class="number">5</span> connected</span><br><span class="line">e3c3977d52165dcb589f59d16a713888abdc0c56 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7003</span>@<span class="number">17003</span> master - <span class="number">0</span> <span class="number">1528994340000</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">0</span>c16f9babaa8def8b721bcd82e43d9258f3f68d9 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7006</span>@<span class="number">17006</span> slave c7693a9c9e1189196481f65153ed41ca9a6fe449 <span class="number">0</span> <span class="number">1528994339000</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">6</span>d9cab72763d1a1fe85be04b6448998b88ea18a2 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7001</span>@<span class="number">17001</span> myself,master - <span class="number">0</span> <span class="number">1528994338000</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line"><span class="number">089</span>b61bc451920a7a0cba996a4a430b8a8805c03 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7004</span>@<span class="number">17004</span> slave e3c3977d52165dcb589f59d16a713888abdc0c56 <span class="number">0</span> <span class="number">1528994339221</span> <span class="number">4</span> connected</span><br><span class="line">c7693a9c9e1189196481f65153ed41ca9a6fe449 <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7002</span>@<span class="number">17002</span> master - <span class="number">0</span> <span class="number">1528994340228</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line"><span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7001</span>&gt; <span class="built_in">set</span> a <span class="number">100</span></span><br><span class="line">-&gt; Redirected to slot [<span class="number">15495</span>] located at <span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7003</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">10.24</span><span class="number">.33</span><span class="number">.147</span>:<span class="number">7003</span>&gt; get a</span><br><span class="line"><span class="string">"100"</span></span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="唐胡璐" />
            
              <p class="site-author-name" itemprop="name">唐胡璐</p>
              <p class="site-description motion-element" itemprop="description">i just wanna live while i am alive</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">339</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/yongfeiuall" target="_blank" title="LinkedIn">
                      
                        <i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com/yongfeiuall" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yongfeiuall" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="yongfeiuall@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">唐胡璐</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	

		<script type="text/javascript">
		_hcwp = window._hcwp || [];

		_hcwp.push({widget:"Bloggerstream", widget_id: 101212, selector:".hc-comment-count", label: "{\%COUNT%\}" });

		

		(function() {
		if("HC_LOAD_INIT" in window)return;
		HC_LOAD_INIT = true;
		var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
		var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
		hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/101212/"+lang+"/widget.js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hcc, s.nextSibling);
		})();
		</script>

	
















  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Wechat,Linkedin,Weibo,Mailto,Douban,QQZone,Twitter,Reddit,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>
